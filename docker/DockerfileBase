FROM jupyter/base-notebook:7a3e968dd212

USER root
RUN locale-gen en_US.UTF-8
RUN apt-get update -q && apt-get install --yes gcc vim emacs mongodb graphviz
ENV BUILD_DEPS="git devscripts equivs apt-utils apache2-dev libslurm-dev python-setuptools cython python-dev libslurmdb-dev libslurm-dev ca-certificates"
ENV RUN_DEPS="apache2 libapache2-mod-wsgi javascript-common python-flask clustershell libjs-bootstrap libjs-jquery-flot libjs-jquery-tablesorter libmunge-dev munge node-uglify fonts-dejavu-core python-ldap python-redis libjs-requirejs libjs-requirejs-text libjs-three libjs-d3 libjs-handlebars"
RUN apt-get update -q && apt-get -y install $BUILD_DEPS $RUN_DEPS
RUN ln -s /usr/lib/x86_64-linux-gnu/ /usr/lib64
RUN a2enmod wsgi && a2enconf javascript-common

# apt could not locate slurm-llnl
WORKDIR /root
RUN wget https://github.com/SchedMD/slurm/archive/slurm-17-11-8-1.tar.gz
RUN cd /usr/src && tar axvf /root/slurm-17-11-8-1.tar.gz && cd /usr/src/slurm-slurm-17-11-8-1 && \
      ./configure --prefix=/usr && make -j && make install && \
      rm -rf /usr/src/slurm-slurm-17-11-8-1 && rm -f /root/slurm-17-11-8-1.tar.gz
RUN git clone https://github.com/jamesmcclain/SlurmDocker.git && cd SlurmDocker && cp config/slurm.conf.template /etc/
RUN apt-get clean
RUN mkdir -p /usr/etc && touch /usr/etc/slurm.conf && chown -R jovyan:users /usr/etc
RUN mkdir -p /var/{log,lib,run}/munge && chown jovyan:users /var/{log,lib,run}/munge
RUN mkdir -p /var/run/spool && chown jovyan:users /var/run/spool
RUN PASSWORD=${1:-"Setec Astronomy"} && \
  echo -n $PASSWORD | sha512sum | cut -d' ' -f1 > /tmp/munge.key && \
  chown jovyan:users /tmp/munge.key && \
  chmod go-rwx /tmp/munge.key

USER $NB_USER
WORKDIR /home/jovyan
RUN mkdir /home/jovyan/mongodb

RUN wget -O requirements_fireworks.txt https://raw.githubusercontent.com/materialsproject/fireworks/master/requirements.txt && \
    pip install -r requirements_fireworks.txt
RUN wget -O requirements_workshop.txt https://raw.githubusercontent.com/materialsproject/workshop/master/requirements.txt && \
    pip install -r requirements_workshop.txt
RUN wget -O requirements_crystaltoolkit.txt https://raw.githubusercontent.com/materialsproject/crystaltoolkit/master/requirements.txt && \
    pip install -r requirements_crystaltoolkit.txt
RUN wget -O requirements_mpcontribs-client.txt https://raw.githubusercontent.com/materialsproject/MPContribs/dev/mpcontribs-client/requirements.txt && \
    pip install -r requirements_mpcontribs-client.txt
RUN wget -O requirements_mpcontribs-io.txt https://raw.githubusercontent.com/materialsproject/MPContribs/dev/mpcontribs-io/requirements.txt && \
    pip install -r requirements_mpcontribs-io.txt
RUN pip install --no-cache-dir --upgrade Jinja2 python-dateutil
RUN pip install --upgrade --ignore-installed terminado --force jupyter ipython jupyter-console nbconvert
RUN jupyter nbextension install --user --py pythreejs
RUN jupyter nbextension enable --user --py pythreejs
RUN jupyter serverextension enable --sys-prefix jupyter_server_proxy
RUN pip install --no-cache-dir nbzip
RUN jupyter serverextension enable --py nbzip --sys-prefix
RUN jupyter nbextension install --user --py nbzip
RUN jupyter nbextension enable --user --py nbzip

RUN mkdir -p /home/jovyan/mpcontribs-webtzite/webtzite
RUN wget -O mpcontribs-webtzite/webtzite/package.json https://raw.githubusercontent.com/materialsproject/MPContribs/dev/mpcontribs-webtzite/webtzite/package.json
RUN wget https://raw.githubusercontent.com/materialsproject/MPContribs/dev/package.json
RUN npm install 2>&1

WORKDIR /home/jovyan
